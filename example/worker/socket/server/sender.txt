//  Author: Corey Ferguson
//  Date:   September 21, 2023
//  File:   sender.txt
//

include("/Library/Application Support/SimpleScript/example/socket/tcp/util/server.txt")
include((dir = "@/datetime/") + "isoString")
include(dir + "parseTime")
include("@/search/string/replace")

func onExit(_)
    if connected
        echo "\n"
        echo "Are you sure? (y/N)\n"
        echo "Press return, then answer..."
        
        if toLower (input() ?? "") === "y"
            connected = false
            
            return true
        end if
        
        return false
    end if
    
    return true
end func

func onMessage(_, message)
    if message === undefined
        if connected
            connected = false
            
            echo "\n"
            echo "Disconnected.\n"
            echo "Press return to continue...\n"
        end if
        
        return
    end if

    echo "\n"
    echo "[{}] {}\n" format array(parseTime(local()), message)
    
    worker("/Library/Application Support/SimpleScript/example/worker/socket/receiver.txt", first cfds)
end func

func main()
    sfd = server(1)

    array cfds = null
    
    connected = false

    while 1
        while !(cfds = poll(sfd))
            sleep 1_000
        end while
        
        echo "Connected...\n"
        
        connected = true
        
        worker("/Library/Application Support/SimpleScript/example/worker/socket/receiver.txt", first cfds)
        
        while 1
            echo "> "
        
            req = null
            while connected && !(req = string(input() ?? ""))
                continue
            end while
        
            if !connected
                break
            end if
            
            try
                send(first cfds, req)
            catch errno
                throw ERRNOs().errno
            end try
        end while

        try
            closeTcp(first cfds)
        catch errno
            throw ERRNOs().errno
        end try
    end while
end func

main()
