//  Author: Corey Ferguson
//  Date:   September 21, 2023
//  File:   sender.txt
//

include("/Library/Application Support/SimpleScript/example/socket/tcp/util/client.txt")
include((dir = "@/datetime/") + "isoString")
include(dir + "parseTime")
include("@/search/string/replace")

func onExit(_)
    echo "\n"
    echo "Are you sure? (y/N)\n"
    echo "Press return, then answer..."
    
    if toLower (input() ?? "") === "y"
        connected = false
        
        return true
    end if
    
    return false
end func

func onMessage(message)
    if message === undefined
        connected = false
    
        echo "\n"
        echo "Disconnected.\n"
        echo "Press return to continue...\n"
        
        return
    end if

    echo "\n"
    echo "[{}] {}\n" format array(parseTime(local()), message)
    
    worker("/Library/Application Support/SimpleScript/example/worker/socket/receiver.txt", sfd)
end func

func main()
    while 1
        sfd = client(8080)
        
        echo "Connected...\n"
        
        connected = true
        
        worker("/Library/Application Support/SimpleScript/example/worker/socket/receiver.txt", sfd)

        while 1
            echo "> "
        
            req = null
            while connected && !(req = string(input() ?? ""))
                continue
            end while

            if !connected
                break
            end if
            
            try
                send(sfd, req)
            catch errno
                throw ERRNOs().errno
            end try
        end while
        
        try
            closeTcp(sfd)
        catch errno
            throw ERRNOs().errno
        end try
    end while
end func

main()
